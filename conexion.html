<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MigraciÃ³n RTDB â†’ Firestore</title>
</head>

<body>
<h1>Datos desde RTDB</h1>
<div id="datos"></div>

<button id="btnEnviar">ENVIAR A FIRESTORE</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";

  // Firestore
  import { 
    getFirestore,
    doc,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

  // Realtime Database
  import {
    getDatabase,
    ref,
    onValue
  } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  // CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyC7YUiNYU2I4FzJL2IJzpdybFc7iD9ZYVw",
    authDomain: "minebyte51m.firebaseapp.com",
    projectId: "minebyte51m",
    storageBucket: "minebyte51m.firebasestorage.app",
    messagingSenderId: "612192107615",
    appId: "1:612192107615:web:6c374d21d070496779afea",
    measurementId: "G-TB1JGW4CX6",
    databaseURL: "https://minebyte51m-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const firestore = getFirestore(app);
  const rtdb = getDatabase(app);

  const nodo = ref(rtdb, "/sensores");

  let datosActuales = {};
  let ultimoGuardado = {};  // ðŸ‘ˆ agregado

  // ===============================
  // MOSTRAR EN PANTALLA Y GUARDAR EN MEMORIA
  // ===============================
  onValue(nodo, snapshot => {
    datosActuales = snapshot.val() || {};
    document.getElementById("datos").innerHTML =
      "<pre>" + JSON.stringify(datosActuales, null, 2) + "</pre>";
  });


  // ===============================
  // ENVIAR CUANDO SE PRESIONA EL BOTÃ“N
  // ===============================
  document.getElementById("btnEnviar").addEventListener("click", async () => {

    if (!datosActuales || Object.keys(datosActuales).length === 0) {
      alert("No hay datos para enviar");
      return;
    }

    for (const sensor in datosActuales) {

      const refDoc = doc(firestore, "migracion", sensor);

      const nuevosDatos = datosActuales[sensor];

      // comparar con ultimo guardado
      const cambio = JSON.stringify(nuevosDatos) !== JSON.stringify(ultimoGuardado[sensor]);

      if (cambio) {

        await setDoc(refDoc, {
          ...nuevosDatos,
          timestamp_copy: new Date().toISOString()
        });

        console.log(`âœ” Cambios detectados â†’ guardado en Firestore: ${sensor}`);

        ultimoGuardado[sensor] = nuevosDatos;

      } else {
        console.log(`â›” Sin cambios en ${sensor} â†’ no se guarda`);
      }
    }

    alert("Proceso terminado.");
  });

</script>

</body>
</html>
